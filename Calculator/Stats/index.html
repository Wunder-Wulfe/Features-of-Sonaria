<!DOCTYPE html>
<html>
<head>
<meta name="twitter:card" content="summary" />
<meta property="og:title" content="Features of Sonaria: Damage Calculator" />
<meta property="og:description" content="Calculate damage values after taking into account the proportions between the weights of creatures." />
<meta property="og:image" content="https://wunder-wulfe.github.io/Features-of-Sonaria/Calculator/Damage/demo.png">
<link rel="shortcut icon" href="https://wunder-wulfe.github.io/Features-of-Sonaria/icon.ico">
<title>Damage Calculator</title>
<script defer src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-chtml.js"></script>
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="../../style/theme.css">
<style>
html {
    background: var(--primary-color);
    color: var(--text-color);
}

table {
    background: var(--secondary-color);
    letter-spacing: -0.025em;
}

body:not(.MathJax) {
    text-align: center;
    font-family: Helvetica, Arial;
    font-size: 1.2em;
}

.MathJax {
    font-size: 1.1em !important;
    padding: 0;
    margin: 0;
}

span {
    font-weight: bold;
}

h1 {
    padding: 25px;
    margin: auto;
}

td {
    padding: 0.15em;
    text-align: right !important;
    vertical-align: bottom !important;
    line-height: 60px;
    font-size: 0.85em;
}

input[type=checkbox] {
    width: 1.5em;
    height: 1.5em;
}

.stat-box {
    background: #3F3F3F;
    width: 85%;
    margin: auto;
    border-radius: 0.5em;
    font-size: 3.0em;
}

.tx-stats {
    font-weight: bold;
    font-size: 1.3em;
    
    text-align: center !important;
    
    background: linear-gradient(to bottom, #FFF, #DDD, #333);
    -webkit-background-clip: text;
    -webkit-text-stroke: 0.035em #333;
    background-clip: text;
    color: transparent;
}

.tx-age {
    font-size: 0.4em;
    -webkit-text-stroke: 0.03em #333;
}

.dynamic {
    --dynamic-dark: #333;
    color: var(--dynamic-color);
    -webkit-text-stroke: 0.035em var(--dynamic-dark);
    text-align: left !important;
}

.tx-hp {
    --dynamic-color: #61FF6B;
    --dynamic-dark: #18401B;
}

.tx-dmg {
    --dynamic-color: #F33;
    --dynamic-dark: #322;
}

.tx-stam {
    --dynamic-color: #FE1;
    --dynamic-dark: #332;
}

.tx-wgt {
    --dynamic-color: #CF9;
    --dynamic-dark: #231;
}

.tx-spd {
    --dynamic-color: #2CF;
    --dynamic-dark: #023;
}

.tx-buff 
{
    font-weight: bold;
    font-style: italic;
    font-size: 0.85em;
    
    background: linear-gradient(to bottom, #6A34FF, #6A34FF, #26135A);
    -webkit-background-clip: text;
    -webkit-text-stroke: 0.035em #190C3F;
    background-clip: text;
    color: transparent;
}

.force-left {
    text-align: left !important;
}

.un-text-box
{
    border: none;
    background: none;
    color: inherit;
    text-align: inherit;
    vertical-align: inherit;
    padding: none;
}

.number-box {
    font-style: italic;
    font-weight: bold;
    border: none;
    background: none;
    color: inherit;
    -webkit-text-stroke: 0.03em #333;
    display: inline;
    font-family: inherit;
    font-size: 0.9em;
    text-align: inherit;
    vertical-align: inherit;
    padding: none;
    width: 100%;
    overflow: visible !important;
}

input.number-box {
    border: 0.05em solid rgba(200,200,200,0.15);
    padding: 0.02em;
    background: rgba(10,10,10,0.15);
    border-radius: 0.2em;
}

.buff-positive {
    color: #3B6;
    -webkit-text-stroke: 0.03em #132;
}

.buff-negative {
    color: #F44;
    -webkit-text-stroke: 0.03em #311;
}

.ailment-list {
  width: 100%;
  display: flex;
  flex-flow: row wrap;
  justify-content: center;
  align-items: center;
  align-content: center;
  margin: 0;
  padding: 0;
  vertical-align: middle;
  text-align: center;
}

.ailment {
  position: relative;
  margin: 0.8em;
  vertical-align: center;
  text-align: center;
  width: 7.5em;
  height: 7.5em;
  z-index: 1;
}

.ail-main {
    filter: drop-shadow(0 0 0.5rem black);
}

.nudge:before {
    content: "\00a0\00a0\00a0";
}

.btn-close {
    position: absolute;
    width: 3em;
    height: 3em;
    top: 60%;
    left: -10%;
    z-index: 2;
}

.tx-ail {
    font-size: 5em;
    line-height: 0.75em;
    position: absolute;
    text-align: center;
    vertical-align: center;
    top: 0;
    left: 0;
    margin: 0;
    padding: 0;
    word-break: break-all;
    width: 100%;
    height: 100%;
    font-weight: bold;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    align-items: center;
}

.tx-stack {
    position: absolute;
    width: 110%;
    height: 32%;
    left: -10%;
    top: 0%;
    text-align: right;
    font-size: 3.25em;
    border-radius: 0.2em;
    -webkit-text-stroke: 0.03em #222;
    transition: 0.1s ease-in-out;
    font-weight: bold;
    
    &:hover {
        background: rgba(20,20,20,0.5);
    }
}

.cramped {
    letter-spacing: -0.07em;
}

.tx-kind {
    height: 100%;
    width: 100%;
    font-weight: bold;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    align-items: center;
    text-align: left;
    text-transform: uppercase;
    font-size: 1em;
}

img {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
}

.collapsible {
    position: absolute;
    background: rgba(50,50,50,0.95);
    width: 300%;
    height: 200%;
    left: -100%;
    top: -210%;
    outline: 0.2em solid rgba(40,40,40,0.95);
    border-radius: 0.2em;
    display: flex;
    justify-content: flex-start;
    align-items: stretch;
    flex-flow: column;
}

.ailment-info {
    background: none;
    height: 25%;
    width: 100%;
}

.ailment-table {
    font-size: 2em;
}

.tx-effect {
    text-align: right;
}

.tx-center {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    align-items: center;
}

.ailment-plus {
    background: rgba(80,80,80,0.4);
    outline: 0.1em solid rgba(90,90,90,0.4);
    outline-offset: -0.1em;
    border-radius: 0.1em;
    vertical-align: middle;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    align-items: center;
    font-size: 2em;
} 

.container {
    width: 100%;
    height: 100%;
}

.clickable {
    transition: 0.1s ease-in-out;
    user-select: none;
}

.clickable:hover {
    filter: brightness(80%);
}

.clickable:active {
    filter: brightness(50%);
}

</style>
</head>
<body>
<h1>
Stat Calculator
</h1>
<br /><hr /><br />
<h2>Base Stats</h2>
<br />
<table class="stat-box">
<colgroup>
   <col span="1" style="width: 29%;">
   <col span="1" style="width: 9%;">
   <col span="1" style="width: 19%;">
   <col span="1" style="width: 14%;">
</colgroup>
    <tbody>
        <tr>
            <td></td>
            <td class="tx-stats">Stats</td>
            <td class="tx-age">(altered with age)</td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-hp">Health</td>
            <td><input class="number-box" id="health" type="text" onkeypress="return validLong(event)" value="0"/></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Regen</td>
            <td><input class="number-box" id="hpr" type="text" onkeypress="return validLong(event)" value="0" mark=" %"/></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-dmg">Damage</td>
            <td><input class="number-box" id="damage" type="text" onkeypress="return validLong(event)" value="0"/></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-stam">Stamina</td>
            <td><input class="number-box" id="stamina" type="text" onkeypress="return validLong(event)" value="0" positive /></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Regen</td>
            <td><input class="number-box" id="str" type="text" onkeypress="return validFloat(event)" value="0.0" places="1" decimal /></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-wgt">Weight</td>
            <td><input class="number-box" id="weight" type="text" onkeypress="return validLong(event)" value="0" mark=" lbs" positive /></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-spd">Speed</td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Swim</td>
            <td><input class="number-box" id="swim" type="text" onkeypress="return validLong(event)" value="0" positive /></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Walk</td>
            <td><input class="number-box" id="walk" type="text" onkeypress="return validLong(event)" value="0" positive /></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Sprint</td>
            <td><input class="number-box" id="sprint" type="text" onkeypress="return validLong(event)" value="0" positive /></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Fly</td>
            <td><input class="number-box" id="fly" type="text" onkeypress="return validLong(event)" value="0" positive /></td>
            <td></td>
        </tr>
    </tbody>
</table>
<br /><hr /><br />
<h2>Ailments</h2>
<br />
<div id="ailments" class="ailment-list">
<div class="ailment clickable dont-delete"><img src="ailment_icon.png" class="ail-main"/><div class="tx-ail">+</div></div>
</div>
<br /><hr /><br />
<h2>Modified Stats</h2>
<br />
<table class="stat-box">
<colgroup>
   <col span="1" style="width: 29%;">
   <col span="1" style="width: 9%;">
   <col span="1" style="width: 19%;">
   <col span="1" style="width: 14%;">
</colgroup>
    <tbody>
        <tr>
            <td></td>
            <td class="tx-stats">Stats</td>
            <td class="tx-age">(altered with age)</td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-hp">Health</td>
            <td><span class="number-box" id="health_out">0</span></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Regen</td>
            <td><span class="number-box" id="hpr_out">0 %</span></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-dmg">Damage</td>
            <td><span class="number-box" id="damage_out">0</span></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-stam">Stamina</td>
            <td><span class="number-box" id="stamina_out">0</span></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Regen</td>
            <td><span class="number-box" id="str_out">0.0</span></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-wgt">Weight</td>
            <td><span class="number-box" id="weight_out">0 lbs</span></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic tx-spd">Speed</td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Swim</td>
            <td><span class="number-box" id="swim_out">0</span></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Walk</td>
            <td><span class="number-box" id="walk_out">0</span></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Sprint</td>
            <td><span class="number-box" id="sprint_out">0</span></td>
            <td></td>
        </tr>
        <tr>
            <td class="tx-buff"></td>
            <td class="dynamic nudge">Fly</td>
            <td><span class="number-box" id="fly_out">0</span></td>
            <td></td>
        </tr>
    </tbody>
</table>
<script>
    MathJax = {
        tex: {inlineMath: {'[+]': [['$', '$']]}},
        svg: {fontCache: 'global'},
        startup: {
            ready: () => {
                let x = MathJax.startup.defaultReady();
                
                return x;
            }
        }
    };
    
    let to_char = str => str.charCodeAt(0);
    var codeZero = to_char('0');
    var codeNine = to_char('9');
    var codeDot = to_char('.');
    var codeComma = to_char(',');
    function validInt(value)
    {
        return value.charCode >= codeZero && value.charCode <= codeNine;
    }
    
    function validLong(value)
    {
        return value.charCode == codeComma || validInt(value);
    }
    
    function validFloat(value)
    {
        return value.charCode == codeDot || validInt(value);
    }
    
    function validLongFloat(value)
    {
        return value.charCode == codeComma || validFloat(value);
    }
    
    function isEmpty(str)
    {
        return str.trim().length === 0 
    }
    
    function addCommas(num)
    {
        return num.toLocaleString('en-US');
    }
    
    function checkNaN(val, def=0)
    {
        return val==val ? val : def;
    }
    function replaceIfEmpty(str, value=0)
    {
        return isEmpty(str) ? value : checkNaN(+str, value);
    }
    
    function tblRow(data=null, id=null, cls=null)
    {
        let r = document.createElement('tr');
        let c = document.createElement('td');
        if (data !== null) c.append(data);
        r.append(c);
        if (cls !== null) r.className  = cls;
        if (id !== null) r.id = id;
        return r;
    }
    
    function addMathRow(eq)
    {
        $('#results').append(tblRow(`$$${eq}$$`, null, 'step'));	
    }
    
    function reRenderMath()
    {
        MathJax.texReset();
        MathJax.typesetPromise();
    }
    
    function round(num, places=0)
    {
        const shift = Math.pow(10, places);
        return num < 0 ? (-Math.floor(-num * shift + 0.5) / shift) 
            : (Math.floor(num * shift + 0.5) / shift);
    }
    
    function s(n)
    {
        return round(n, 5);
    }
    
    
    function removeSubstring(str, sub)
    {
        return str.split(sub).join('');
    }
    
    function removeAllSubstrings(str, ...subs)
    {
        for (let sub of subs)
            str = removeSubstring(str, sub);
        return str;
    }
    
    function extractNumber(str)
    {
        return +str.replace(/[^0-9.]/g, '');
    }
    
    function roundForInput(number, input)
    {
        return round(number, input.getAttribute('places') ?? 0); 
    }
    
    function getParts(number)
    {
        let whole = Math.floor(number);
        return [whole, Math.abs(number - whole)];
    }
    
    function joinParts(whole, frac, commas=false)
    {
        return (commas ? addCommas(whole) : whole.toString()) + frac.toString().substring(1);
    }
    
    function formatForInput(number, input)
    {
        let decimal = input.getAttribute('decimal') !== null;
        
        let num = roundForInput(number, input);
        
        let tx;
        
        if (!decimal)
            tx = addCommas(num);
        else
        {
            let whole = Math.floor(num);
            
            let frac = Math.abs(num - whole);
            
            let places = input.getAttribute('places') ?? 0;
            
            frac = frac.toFixed(places).substring(1);
            
            tx = addCommas(whole) + frac;
        }
            
        let mark = input.getAttribute('mark');
        
        if (mark !== null)
            tx += mark;
            
        return tx;
    }
    
    function recalculateAilments()
    {
        for (let child of $('input.number-box').toArray())
        {
            let out = $(`#${child.id}_out`);
            let buff_tx = out.parent().parent().find('.tx-buff');
            
            let number = extractNumber(child.value);
            
            let hidden_buff = 1.0;
            
            number *= hidden_buff;
            
            let pos_only = child.getAttribute('positive') !== null;
            
            if (pos_only && number < 0) number = 0.0;
            
            let original = roundForInput(number, child);
            
            let buff = 0.5;
            let additive = 0.0;
            
            number = number * buff + number * additive;
            
            if (pos_only && number < 0) number = 0.0;
            
            number = roundForInput(number, child);
            
            let change = original==0 ? 0 : 100 * (number - original) / original;
            
            let [whole, frac] = getParts(change);
            
            frac = round(frac, 1).toFixed(1);
            
            let pls = change > 0 ? '+' : '';
            
            let changetx = change==0 ? '' : `(${pls}${joinParts(whole,frac,true)}%)`;
            
            let is_good = change > 0;
            let is_bad = change < 0;
            
            let single = out[0];
            single.classList.remove('buff-positive');
            single.classList.remove('buff-negative');
            if (is_good)
                single.classList.add('buff-positive');
            else if (is_bad)
                single.classList.add('buff-negative');
            
            out.html(formatForInput(number, child));
            
            buff_tx.html(changetx);
        }
    }
    
    function onInputChange()
    {
        let [cs, ce] = [this.selectionStart, this.selectionEnd]; // Save cursor position
        
        cs = this.value.length - cs;
        ce = this.value.length - ce;
      
        let tx = this.value.replace(/[^0-9.]/g, '');

        this.value = formatForInput(replaceIfEmpty(tx, 0), this);
        
        this.setSelectionRange(tx.length - cs, tx.length - ce);
        
        recalculateAilments();
    }
    
    function onCloseClick(event)
    {
        $(this).parent().remove();
        
        event.stopPropagation();
    }
    
    function jquerySame(q1, q2)
    {
        if (q1.length !== q2.length) return false;
        
        for (let index = 0; index < q1.length; index++)
            if (q1.get(index) !== q2.get(index)) 
                return false;
            
        return true;
    }
    
    function onAilmentClick(event)
    {
        const clickable = $(event.target).closest('.clickable');
        if (!jquerySame(clickable, $(this))) return;
        
        const parent = $(this).parent();
        const hidden = parent.find('.collapsible').is(":hidden");
        parent.parent().find('.collapsible').hide();
        parent.find('.collapsible').toggle(hidden);
        
        event.stopPropagation();
    }
    
    function passthrough(event) { event.stopPropagation(); }
    

    
    for (let child of $('input.number-box').toArray())
    {
        $(child).on('change', onInputChange);
        onInputChange.call(child);
    }
    
    const ailment_adder = '<div class="ailment-info ailment-plus clickable">+</div>';
    
    const ailment_stat = '<table class="ailment-info ailment-table"><colgroup><col span="1" style="width: 5%;"><col span="1" style="width: 60%;"><col span="1" style="width: 50%;"></colgroup><tbody><tr><td class="clickable remover tx-center">-</td><td><input type="text" class="un-text-box cramped tx-kind" id="effect" value="EFFECT"/></td><td class="clickable tx-effect">+</td></tr></tbody></table>';
    
    const ailment_template = '<div class="ailment custom-ailment"><div class="clickable container"><img src="ailment_icon.png" class="ail-main" /></div><img class="btn-close clickable" src="close_icon.png"><input type="text" class="un-text-box tx-stack cramped" value="" /><div class="collapsible" hidden>'+ailment_adder+'</div></div>';
    
        
    function onMinusClick()
    {
        const tbl = $(this).closest('.ailment-table');
        
        const container = tbl.parent();
        
        tbl.remove();
        
        container.find('.ailment-plus').show();
    }
    
    function onPlusClick()
    {
        const container = $(this).parent();
        
        let new_stat = $(ailment_stat).insertBefore($(this));
        
        new_stat.find('.remover').on('click', onMinusClick);
        
        $(this).toggle(container.children().length <= 4); 
    }
    
    $('.dont-delete').on('click', function(){     
        let new_ailment = $(ailment_template).insertBefore($('.dont-delete'));
        
        new_ailment.find('.collapsible').hide();
        
        new_ailment.find('.container').on('click', onAilmentClick);
        
        new_ailment.find('.btn-close').on('click', onCloseClick);
        
        new_ailment.find('.ailment-plus').on('click', onPlusClick);
    });
</script>
</body>
</html>
